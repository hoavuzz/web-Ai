<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Piano Keyboard Demo - Fox</title>
  <style>
    :root{--white:#fff;--black:#333;--accent:#16a34a}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#f7faf7;color:#0f172a}
    h1{font-size:18px;margin-bottom:8px}
    .kbd{display:flex;gap:6px;align-items:end}
    .key{width:48px;height:180px;border:1px solid #ddd;background:var(--white);border-radius:6px;box-shadow:0 4px 6px rgba(2,6,23,0.06);display:flex;align-items:end;justify-content:center;position:relative;cursor:pointer;user-select:none}
    .key.black{width:36px;height:120px;background:#111;color:#fff;margin-left:-18px;margin-right:-18px;z-index:2;border-radius:4px}
    .label{font-size:12px;padding:6px}
    .controls{margin-top:12px;display:flex;gap:8px;align-items:center}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    button.secondary{background:#64748b}
    .status{margin-left:12px;font-size:14px}
    .timeline{margin-top:12px;background:#fff;padding:12px;border-radius:8px;border:1px dashed #e2e8f0}
    pre{white-space:pre-wrap;font-size:12px}
    .key.playing{outline:3px solid rgba(34,197,94,0.18)}
  </style>
</head>
<body>
  <h1>Piano thử nghiệm — nhấn phím trên bàn phím để chơi (A S D F G H J K L cho nốt C4→A4)</h1>
  <div>Phím: <strong>A S D F G H J K L</strong> tương ứng nốt: C4 D4 E4 F4 G4 A4 B4 C5 D5</div>

  <div class="kbd" id="keyboard" style="margin-top:12px">
    <!-- White keys C4 D4 E4 F4 G4 A4 B4 C5 D5 -->
    <div class="key" data-note="C4"> <div class="label">C4<br><small>A</small></div></div>
    <div class="key" data-note="D4"> <div class="label">D4<br><small>S</small></div></div>
    <div class="key" data-note="E4"> <div class="label">E4<br><small>D</small></div></div>
    <div class="key" data-note="F4"> <div class="label">F4<br><small>F</small></div></div>
    <div class="key" data-note="G4"> <div class="label">G4<br><small>G</small></div></div>
    <div class="key" data-note="A4"> <div class="label">A4<br><small>H</small></div></div>
    <div class="key" data-note="B4"> <div class="label">B4<br><small>J</small></div></div>
    <div class="key" data-note="C5"> <div class="label">C5<br><small>K</small></div></div>
    <div class="key" data-note="D5"> <div class="label">D5<br><small>L</small></div></div>
  </div>

  <div class="controls">
    <button id="record">Ghi lại</button>
    <button id="stop" class="secondary">Dừng</button>
    <button id="playback" class="secondary">Phát lại</button>
    <button id="download" class="secondary">Tải JSON</button>
    <div class="status" id="status">Trạng thái: <em>idle</em></div>
  </div>

  <div class="timeline" id="timeline">
    <strong>Ghi chú:</strong>
    <ul>
      <li>Nhấn phím vật lý A S D F G H J K L để phát nốt.</li>
      <li>Nhấn chuột lên ô phím cũng phát.</li>
      <li>Ghi lại sẽ lưu chuỗi sự kiện (nốt + thời điểm) và xuất ra JSON.</li>
    </ul>
    <pre id="log">[]</pre>
  </div>

  <script>
    // Map phím vật lý -> note
    const keyMap = {
      a: 'C4', s: 'D4', d: 'E4', f: 'F4', g: 'G4', h: 'A4', j: 'B4', k: 'C5', l: 'D5'
    };

    // Tần số cơ bản cho nốt
    const freqTable = {
      C4:261.6256, D4:293.6648, E4:329.6276, F4:349.2282, G4:391.9954, A4:440.0000, B4:493.8833, C5:523.2511, D5:587.3295
    };

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playNote(note, duration=0.4){
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freqTable[note] || 440;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(0.9, now + 0.01);
      gain.gain.linearRampToValueAtTime(0.0001, now + duration);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + duration + 0.02);
    }

    // UI
    const keys = document.querySelectorAll('.key');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    keys.forEach(k => {
      k.addEventListener('pointerdown', () => {
        const note = k.dataset.note;
        trigger(note);
      });
    });

    // Recording
    let recording = false;
    let recordStart = 0;
    let events = [];

    function startRecording(){ events = []; recording = true; recordStart = performance.now(); statusEl.innerHTML = 'Trạng thái: <em>recording</em>'; }
    function stopRecording(){ recording = false; statusEl.innerHTML = 'Trạng thái: <em>idle</em>'; updateLog(); }

    function trigger(note){
      // visual
      const el = [...keys].find(x => x.dataset.note === note);
      if(el){ el.classList.add('playing'); setTimeout(()=>el.classList.remove('playing'), 180); }

      // sound
      playNote(note);

      // record
      if(recording){
        events.push({note, t: Math.round(performance.now() - recordStart)});
        updateLog();
      }
    }

    document.addEventListener('keydown', (e)=>{
      if(e.repeat) return;
      const k = e.key.toLowerCase();
      if(keyMap[k]){
        trigger(keyMap[k]);
      }
    });

    // Buttons
    document.getElementById('record').addEventListener('click', ()=>{
      startRecording();
    });
    document.getElementById('stop').addEventListener('click', ()=>{
      stopRecording();
    });
    document.getElementById('playback').addEventListener('click', async ()=>{
      if(events.length===0) return alert('Chưa có bản ghi.');
      statusEl.innerHTML = 'Trạng thái: <em>playing</em>';
      const start = performance.now();
      for(const ev of events){
        const wait = ev.t - (performance.now() - start);
        if(wait>0) await new Promise(r=>setTimeout(r, wait));
        trigger(ev.note);
      }
      statusEl.innerHTML = 'Trạng thái: <em>idle</em>';
    });

    document.getElementById('download').addEventListener('click', ()=>{
      if(events.length===0) return alert('Chưa có bản ghi để tải.');
      const payload = {metadata:{title:'Fox-demo',created:new Date().toISOString()},events};
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'piano-record.json'; a.click();
      URL.revokeObjectURL(url);
    });

    function updateLog(){ logEl.textContent = JSON.stringify(events, null, 2); }

    // enable audio on first user gesture for mobile
    window.addEventListener('pointerdown', () => {
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }, {once:true});

  </script>
</body>
</html>